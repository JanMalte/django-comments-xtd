(()=>{"use strict";class CommentForm{constructor(e){this.formWrapper=e,this.init()}click_on_post(e){return this.post("post")}click_on_preview(e){return this.post("preview")}init(){this.formWrapperEl=document.querySelector(this.formWrapper),this.formEl=this.formWrapperEl.querySelector("form");const e=this.formEl.elements.post,t=this.formEl.elements.preview;e.addEventListener("click",(e=>this.post("post"))),t.addEventListener("click",(e=>this.post("preview"))),e.type="button",t.type="button"}disable_btns(e){this.formEl.elements.post.disabled=e,this.formEl.elements.preview.disabled=e}is_valid(){for(const e of this.formEl.querySelectorAll("[required]"))if(!e.reportValidity())return e.focus(),!1;return!0}post(e){if(!this.is_valid())return;this.disable_btns(!0);const t=this.formWrapperEl.querySelector("[data-dcx=preview]");t&&t.remove();const n=new FormData(this.formEl);return void 0!==e&&n.append(e,1),fetch(this.formEl.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:n}).then((t=>{"preview"===e?this.handle_preview_comment_response(t):"post"===e&&this.handle_post_comment_response(t)})),this.disable_btns(!1),!1}async handle_preview_comment_response(e){const t=await e.json();200===e.status?(this.formWrapperEl.innerHTML=t.html,this.init(),t.field_focus&&this.formEl.querySelector(`[name=${t.field_focus}]`).focus()):400===e.status&&(this.formEl.innerHTML=t.html)}async handle_post_comment_response(e){const t=await e.json();200===e.status?(this.formWrapperEl.innerHTML=t.html,this.init(),t.field_focus&&this.formEl.querySelector(`[name=${t.field_focus}]`).focus()):201===e.status||202===e.status||400===e.status?this.formEl.innerHTML=t.html:e.status>400&&alert("Something went wrong and your comment could not be processed. Please, reload the page and try again.")}}class ReplyFormsHandler{constructor(e,t){this.replyFormBase=document.querySelector(e),this.replyMap=new Map;const n=window.dcx.page_param||"cpage";for(const s of document.querySelectorAll(t)){const e=s.querySelector("form");if(null===e)return void console.error(`Could not find a reply form within one of the elements retrieved with ${t}.`);const i=e.elements.reply_to.value,o=e.elements[n]?e.elements[n].value:null,l=this.replyFormBase.cloneNode(!0);l.dataset.dcx=`reply-form-${i}`;const r=l.querySelector("form");r.elements.reply_to.value=i,o&&(r.elements[n].value=o);const a=s.parentNode;s.replaceWith(l),this.init(i),this.replyMap.set(i,a)}}init(e,t){const n=`[data-dcx=reply-form-${e}]`,s=document.querySelector(n),i=s.querySelector("form");i.elements.post.addEventListener("click",this.send_clicked(e));i.elements.preview.addEventListener("click",this.preview_clicked(e));i.elements.cancel.addEventListener("click",this.cancel_clicked(e)),i.style.display="none";const o=s.querySelector("[data-dcx=reply-textarea]");o.querySelector("textarea").addEventListener("focus",this.textarea_focus(e)),!0===t&&(s.classList.add("active"),o.style.display="none",i.style="",i.elements.comment.focus())}get_map_item(e){const t=this.replyMap.get(e);if(void 0===t){const t=`replyMap doesn't have a key ${e}`;throw console.error(t),t}return t}disable_buttons(e,t){e.elements.post.disabled=t,e.elements.preview.disabled=t}is_valid(e){for(const t of e.querySelectorAll("[required]"))if(!t.reportValidity())return t.focus(),!1;return!0}textarea_focus(e){return t=>{const n=this.get_map_item(e),s=`[data-dcx=reply-form-${e}`,i=n.querySelector(s),o=i.querySelector("form"),l=i.querySelector("[data-dcx=reply-textarea]");i.classList.toggle("active"),l.style.display="none",o.style="",o.elements.comment.focus()}}cancel_clicked(e){return t=>{const n=this.get_map_item(e),s=`[data-dcx=reply-form-${e}`,i=n.querySelector(s),o=i.querySelector("form"),l=i.querySelector("[data-dcx=reply-textarea]"),r=o.elements.comment.value;l.querySelector("textarea").value=r,i.classList.toggle("active"),o.style.display="none",l.style="";const a=n.querySelector("[data-dcx=preview]");a&&a.remove()}}preview_clicked(e){return t=>{this.post("preview",e)}}send_clicked(e){return t=>{this.post("post",e)}}post(e,t){const n=this.get_map_item(t),s=n.querySelector("form");if(!this.is_valid(s))return;this.disable_buttons(s,!0);const i=n.querySelector("[data-dcx=preview]");i&&i.remove();const o=new FormData(s);return void 0!==e&&o.append(e,1),fetch(s.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:o}).then((n=>{"preview"===e?this.handle_preview_comment_response(n,t):"post"===e&&this.handle_post_comment_response(n,t)})),this.disable_buttons(s,!1),!1}handle_http_200(e,t,n){e.innerHTML=t.html,this.init(n,!0),t.field_focus&&e.querySelector(`[name=${t.field_focus}]`).focus()}handle_http_201_202_400(e,t){e.querySelector("form").innerHTML=t.html}async handle_preview_comment_response(e,t){const n=this.get_map_item(t),s=await e.json();200===e.status?this.handle_http_200(n,s,t):400===e.status&&this.handle_http_201_202_400(n,s)}async handle_post_comment_response(e,t){const n=this.get_map_item(t),s=await e.json();200===e.status?this.handle_http_200(n,s,t):201===e.status||202===e.status||400===e.status?this.handle_http_201_202_400(n,s):e.status>400&&alert("Something went wrong and your comment could not be processed. Please, reload the page and try again.")}}function init_comments(){if(null===window.dcx)return;if(void 0===window.dcx.page_param){const e=document.querySelector("[data-dcx=config]");e&&(window.dcx.page_param=e.getAttribute("data-page-qs-param"))}window.dcx.comment_form=null,window.dcx.reply_forms_handler=null;const e="[data-dcx=comment-form]";null===window.dcx.comment_form&&document.querySelector(e)&&(window.dcx.comment_form=new CommentForm(e));const t="[data-dcx=reply-form-template]",n="[data-dcx=reply-form]";null===window.dcx.reply_forms_handler&&document.querySelector(t)&&document.querySelectorAll(n)&&(window.dcx.reply_forms_handler=new ReplyFormsHandler(t,n))}class ReactionsPanel{constructor({panel_el:e,is_guest:t,login_url:n,react_url:s}=opts){this.panel_el=e,this.arrow_el=e.querySelector(".arrow"),this.is_guest=t,this.login_url=n,this.react_url=s,this.panel_title="",this.panel_title_elem=this.panel_el.querySelector(".title"),this.panel_title_elem&&(this.panel_title=this.panel_title_elem.textContent),this.comment_id=0,this.next_url="",this.on_react_btn_click=this.on_react_btn_click.bind(this),this.on_react_btn_mouseover=this.on_react_btn_mouseover.bind(this),this.on_react_btn_mouseout=this.on_react_btn_mouseout.bind(this),this.add_event_listeners()}add_event_listeners(){const e=this.panel_el.querySelectorAll("BUTTON");console.log(`Found ${e.length} buttons`);for(const t of Array.from(e))t.addEventListener("click",this.on_react_btn_click),t.addEventListener("mouseover",this.on_react_btn_mouseover),t.addEventListener("mouseout",this.on_react_btn_mouseout)}on_react_btn_click(e){if(this.is_guest)window.location.href=`${this.login_url}?next=${this.next_url}`;else{const t=e.target.dataset.code,n=this.react_url.replace("0",this.comment_id),s=new FormData;s.append("reaction",t),s.append("csrfmiddlewaretoken",function get_cookie(e){let t=null;if(document.cookie&&""!==document.cookie){const n=document.cookie.split(";");for(let s=0;s<n.length;s++){const i=n[s].trim();if(i.substring(0,e.length+1)===e+"="){t=decodeURIComponent(i.substring(e.length+1));break}}}return t}("csrftoken")),fetch(n,{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},body:s}).then((e=>this.handle_reactions_response(e)))}}async handle_reactions_response(e){const t=await e.json();if(200===e.status||201===e.status){const e=`#cm-reactions-${this.comment_id}`,n=document.querySelector(e);n&&(n.innerHTML=t.html)}else e.status>400&&alert("Something went wrong and your comment reaction could not be processed. Please, reload the page and try again.")}on_react_btn_mouseover(e){console.log("on_react_btn_mouseover:",e.target.dataset.title),this.panel_title_elem&&(this.panel_title_elem.textContent=e.target.dataset.title)}on_react_btn_mouseout(e){this.panel_title_elem.textContent=this.panel_title}set_position(e){this.panel_el.style.display="block";const t=this.get_absolute_coords(this.panel_el),n=this.get_absolute_coords(e),s=t.width,i=t.height,o=t.top,l=t.left,r=n.width,a=n.top,c=n.left,d=c-l+(r/2-s/2),_=a-o-i-8,h=_+10;if(this.panel_el.dataset.fromLeft=d,this.panel_el.dataset.fromTop=h,this.panel_el.dataset.left=d,this.panel_el.dataset.top=_,this.arrow_el){let e=0;e=r/2+c-(d+l);const t=`translate3d(${e}px, 0px, 0)`;this.arrow_el.style.transform=t}}hide(){clearTimeout(this.enter_delay_timeout),this.exit_delat_timeout=setTimeout((()=>{if(this.panel_el){const e=`translate3d(${this.panel_el.dataset.fromLeft}px, ${this.panel_el.dataset.fromTop}px, 0)`;this.panel_el.style.transform=e,this.panel_el.style.opacity=0,this.panel_el.style.display="none",this.panel_el.style.zIndex=0}}),0)}show(e,t){this.comment_id=t,this.next_url=e.dataset.loginNext||"",this.panel_el.style.transform="none",this.set_position(e),this.enter_delay_timeout=setTimeout((()=>{const e=`translate3d(${this.panel_el.dataset.left}px, ${this.panel_el.dataset.top}px, 0)`;this.panel_el.style.zIndex=1,this.panel_el.style.display="block",this.panel_el.style.transform=e,this.panel_el.style.opacity=1}),0)}get_absolute_coords(e){if(!e)return;const t=e.getBoundingClientRect(),n=window.pageXOffset,s=window.pageYOffset;return{width:t.width,height:t.height,top:t.top+s,right:t.right+n,bottom:t.bottom+s,left:t.left+n}}}class ReactionsHandler{constructor(e){if(this.cfg_el=e,this.is_guest="1"===this.cfg_el.getAttribute("data-guest-user"),this.login_url=this.init_login_url(),this.react_url=this.init_react_url(),this.links=document.querySelectorAll("[data-dcx=reactions-panel]"),0===this.links.length)throw new Error("Cannot initialize reactions panel => There are no elements with [data-dcx=reactions-panel].");this.active_visible_panel=0,this.panels_visibility=new Map,this.event_handlers=[],this.add_event_listeners(),this.listen_to_click_on_links();if(this.panel_el=document.querySelector("[data-dcx=reactions-panel-template]"),void 0===this.panel_el)throw new Error("Cannot find element with ${qs_panel}.");const t={panel_el:this.panel_el,is_guest:this.is_guest,login_url:this.login_url,react_url:this.react_url};this.reactions_panel=new ReactionsPanel(t)}init_login_url(){const e=this.cfg_el.getAttribute("data-login-url");if((null===e||0===e.length)&&this.is_guest)throw new Error("Cannot initialize reactions panel => The [data-login-url] attribute does not exist or is empty.");return e}init_react_url(){const e=this.cfg_el.getAttribute("data-react-url");if(null===e||0===e.length){if(!this.is_guest)throw new Error("Cannot initialize reactions panel => The [data-react-url] attribute does not exist or is empty.");console.info("Couldn't find the data-react-url attribute, but the user is anonymous. She has to login first in order to post comment reactions.")}return e}on_document_click(e){const t=e.target.getAttribute("data-dcx");t&&"reactions-panel"===t||(this.reactions_panel.hide(),this.active_visible_panel&&(console.log(`reactions off: ${this.active_visible_panel}`),this.panels_visibility.set(this.active_visible_panel,!1),this.active_visible_panel=0))}on_document_key_up(e){"Escape"===e.key&&(this.reactions_panel.hide(),this.active_visible_panel&&(console.log(`reactions off: ${this.active_visible_panel}`),this.panels_visibility.set(this.active_visible_panel,!1),this.active_visible_panel=0))}add_event_listeners(){const e=this.on_document_click.bind(this),t=this.on_document_key_up.bind(this);window.document.addEventListener("click",e),window.document.addEventListener("keyup",t),this.event_handlers.push({elem:window.document,event:"click",handler:this.on_document_click}),this.event_handlers.push({elem:window.document,event:"keyup",handler:this.on_document_key_up})}remove_event_listeners(){console.log("Removing events...");for(const e of this.event_handlers)e.elem.removeEventListener(e.event,e.handler)}listen_to_click_on_links(){for(const e of Array.from(this.links)){const t=e.getAttribute("data-comment");if(null===t)continue;const n=this.toggle_reactions_panel(t);e.addEventListener("click",n),this.event_handlers.push({elem:e,event:"click",handler:n}),this.panels_visibility.set(t,!1)}}toggle_reactions_panel(e){return t=>{t.preventDefault();const n=this.panels_visibility.get(e);n?(this.active_visible_panel=0,this.reactions_panel.hide()):(this.active_visible_panel=e,this.reactions_panel.show(t.target,e)),this.panels_visibility.set(e,!n)}}}function init_reactions(){if(null===window.dcx)return;const e=document.querySelector("[data-dcx=config]");null!==e&&null!==window.dcx&&(window.dcx.reactions_handler=null,null===window.dcx.reactions_handler&&(window.dcx.reactions_handler=new ReactionsHandler(e),window.addEventListener("beforeunload",(e=>{console.log("About to call reactions_handler.remove_events()"),window.dcx.reactions_handler.remove_event_listeners()}))))}window.dcx.init_comments=init_comments,window.dcx.init_reactions=init_reactions,window.addEventListener("DOMContentLoaded",(e=>{null!==window.dcx&&(init_comments(),init_reactions())}))})();
//# sourceMappingURL=dcx-3.0.0.min.js.map