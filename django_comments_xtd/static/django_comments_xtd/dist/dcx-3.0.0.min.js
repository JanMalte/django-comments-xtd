(()=>{"use strict";class CommentForm{constructor(e){this.formWrapper=e,this.init()}click_on_post(e){return this.post("post")}click_on_preview(e){return this.post("preview")}init(){this.formWrapperEl=document.querySelector(this.formWrapper),this.formEl=this.formWrapperEl.querySelector("form");const e=this.formEl.elements.post,t=this.formEl.elements.preview;e.addEventListener("click",(e=>this.post("post"))),t.addEventListener("click",(e=>this.post("preview"))),e.type="button",t.type="button"}disable_btns(e){this.formEl.elements.post.disabled=e,this.formEl.elements.preview.disabled=e}is_valid(){for(const e of this.formEl.querySelectorAll("[required]"))if(!e.reportValidity())return e.focus(),!1;return!0}post(e){if(!this.is_valid())return;this.disable_btns(!0);const t=this.formWrapperEl.querySelector("[data-dcx=preview]");t&&t.remove();const o=new FormData(this.formEl);return void 0!==e&&o.append(e,1),fetch(this.formEl.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:o}).then((t=>{"preview"===e?this.handle_preview_comment_response(t):"post"===e&&this.handle_post_comment_response(t)})),this.disable_btns(!1),!1}async handle_preview_comment_response(e){const t=await e.json();200===e.status?(this.formWrapperEl.innerHTML=t.html,this.init(),t.field_focus&&this.formEl.querySelector(`[name=${t.field_focus}]`).focus()):400===e.status&&(this.formEl.innerHTML=t.html)}async handle_post_comment_response(e){const t=await e.json();200===e.status?(this.formWrapperEl.innerHTML=t.html,this.init(),t.field_focus&&this.formEl.querySelector(`[name=${t.field_focus}]`).focus()):201===e.status||202===e.status||400===e.status?this.formEl.innerHTML=t.html:e.status>400&&alert("Something went wrong and your comment could not be processed. Please, reload the page and try again.")}}class ReplyFormsHandler{constructor(e,t){this.replyFormBase=document.querySelector(e),this.replyMap=new Map;const o=window.dcx.page_param||"cpage";for(const n of document.querySelectorAll(t)){const e=n.querySelector("form");if(null===e)return void console.error(`Could not find a reply form within one of the elements retrieved with ${t}.`);const r=e.elements.reply_to.value,s=e.elements[o]?e.elements[o].value:null,i=this.replyFormBase.cloneNode(!0);i.dataset.dcx=`reply-form-${r}`;const a=i.querySelector("form");a.elements.reply_to.value=r,s&&(a.elements[o].value=s);const c=n.parentNode;n.replaceWith(i),this.init(r),this.replyMap.set(r,c)}}init(e,t){const o=`[data-dcx=reply-form-${e}]`,n=document.querySelector(o),r=n.querySelector("form");r.elements.post.addEventListener("click",this.send_clicked(e));r.elements.preview.addEventListener("click",this.preview_clicked(e));r.elements.cancel.addEventListener("click",this.cancel_clicked(e)),r.style.display="none";const s=n.querySelector("[data-dcx=reply-textarea]");s.querySelector("textarea").addEventListener("focus",this.textarea_focus(e)),!0===t&&(n.classList.add("active"),s.style.display="none",r.style="",r.elements.comment.focus())}get_map_item(e){const t=this.replyMap.get(e);if(void 0===t){const t=`replyMap doesn't have a key ${e}`;throw console.error(t),t}return t}disable_buttons(e,t){e.elements.post.disabled=t,e.elements.preview.disabled=t}is_valid(e){for(const t of e.querySelectorAll("[required]"))if(!t.reportValidity())return t.focus(),!1;return!0}textarea_focus(e){return t=>{const o=this.get_map_item(e),n=`[data-dcx=reply-form-${e}`,r=o.querySelector(n),s=r.querySelector("form"),i=r.querySelector("[data-dcx=reply-textarea]");r.classList.toggle("active"),i.style.display="none",s.style="",s.elements.comment.focus()}}cancel_clicked(e){return t=>{const o=this.get_map_item(e),n=`[data-dcx=reply-form-${e}`,r=o.querySelector(n),s=r.querySelector("form"),i=r.querySelector("[data-dcx=reply-textarea]"),a=s.elements.comment.value;i.querySelector("textarea").value=a,r.classList.toggle("active"),s.style.display="none",i.style="";const c=o.querySelector("[data-dcx=preview]");c&&c.remove()}}preview_clicked(e){return t=>{this.post("preview",e)}}send_clicked(e){return t=>{this.post("post",e)}}post(e,t){const o=this.get_map_item(t),n=o.querySelector("form");if(!this.is_valid(n))return;this.disable_buttons(n,!0);const r=o.querySelector("[data-dcx=preview]");r&&r.remove();const s=new FormData(n);return void 0!==e&&s.append(e,1),fetch(n.action,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:s}).then((o=>{"preview"===e?this.handle_preview_comment_response(o,t):"post"===e&&this.handle_post_comment_response(o,t)})),this.disable_buttons(n,!1),!1}handle_http_200(e,t,o){e.innerHTML=t.html,this.init(o,!0),t.field_focus&&e.querySelector(`[name=${t.field_focus}]`).focus()}handle_http_201_202_400(e,t){e.querySelector("form").innerHTML=t.html}async handle_preview_comment_response(e,t){const o=this.get_map_item(t),n=await e.json();200===e.status?this.handle_http_200(o,n,t):400===e.status&&this.handle_http_201_202_400(o,n)}async handle_post_comment_response(e,t){const o=this.get_map_item(t),n=await e.json();200===e.status?this.handle_http_200(o,n,t):201===e.status||202===e.status||400===e.status?this.handle_http_201_202_400(o,n):e.status>400&&alert("Something went wrong and your comment could not be processed. Please, reload the page and try again.")}}function init_comments(){if(null===window.dcx)return;if(void 0===window.dcx.page_param){const e=document.querySelector("[data-dcx=config]");e&&(window.dcx.page_param=e.getAttribute("data-page-qs-param"))}window.dcx.comment_form=null,window.dcx.reply_forms_handler=null;const e="[data-dcx=comment-form]";null===window.dcx.comment_form&&document.querySelector(e)&&(window.dcx.comment_form=new CommentForm(e));const t="[data-dcx=reply-form-template]",o="[data-dcx=reply-form]";null===window.dcx.reply_forms_handler&&document.querySelector(t)&&document.querySelectorAll(o)&&(window.dcx.reply_forms_handler=new ReplyFormsHandler(t,o))}function init_reactions(){const e=document.querySelector("[data-dcx=config]");if(null===e||null===window.dcx)return;void 0===window.dcx.guest&&(window.dcx.guest=e.getAttribute("data-guest-user")),window.dcx.login_url=function init_login_url(e){const t=e.getAttribute("data-login-url");if((null===t||0===t.length)&&window.dcx.guest&&"1"===window.dcx.guest)throw new Error("Cannot initialize reactions panel => The [data-login-url] attribute does not exist or is empty.");return t}(e),window.dcx.react_url=function init_react_url(e){const t=e.getAttribute("data-react-url");if(null===t||0===t.length){if(window.dcx.guest&&"0"===window.dcx.guest)throw new Error("Cannot initialize reactions panel => The [data-react-url] attribute does not exist or is empty.");console.info("Couldn't find the data-react-url attribute, but the user is anonymous. She has to login first in order to post comment reactions.")}return t}(e);const t=document.querySelectorAll("[data-dcx=reactions-panel]");if(0===t.length)throw new Error("Cannot initialize reactions panel => There are no elements with [data-dcx=reactions-panel].");!function create_buttons_panels(e){const t="[data-dcx=reactions-panel-template]",o=document.querySelector(t);for(const n of Array.from(e)){const e=n.getAttribute("data-comment");if(null===e)continue;const t=o.cloneNode(!0);delete t.dataset.dcx,t.setAttribute("data-crpanel",`${e}`);const r=t.querySelector("h3"),s=r.textContent,i=t.querySelectorAll("P > BUTTON");for(const o of Array.from(i))"0"===window.dcx.guest?o.addEventListener("click",on_click_reaction_btn(o.dataset.code,e)):o.addEventListener("click",(function(e){window.location.href=`${window.dcx.login_url}?next=${login_next_url}`})),o.addEventListener("mouseover",on_mouseover_reaction_btn(r)),o.addEventListener("mouseout",on_mouseout_reaction_btn(r,s));n.parentNode.insertBefore(t,n),calc_buttons_panel_position(e),n.addEventListener("click",toggle_buttons_panel(e))}}(t),document.querySelectorAll("[data-toggle=reactions-tooltip]").forEach((e=>{e.addEventListener("mouseover",on_mouseover_tooltip),e.addEventListener("mouseout",on_mouseout_tooltip)}))}function toggle_buttons_panel(e){return t=>{t.preventDefault(),document.querySelectorAll(".reactions-panel").forEach((t=>{t.getAttribute("data-crpanel")!==e&&(t.style.display="none")}));const o=document.querySelector(`[data-crpanel="${e}"]`);o&&("block"!==o.style.display?o.style.display="block":o.style.display="")}}function calc_buttons_panel_position(e){const t=document.querySelector(`[data-crpanel="${e}"]`);if(t){const o=document.querySelector("[data-dcx=config]"),n=parseInt(o.getAttribute("data-popover-pos-bottom"))||0,r=parseInt(o.getAttribute("data-popover-pos-left"))||0,s=`[data-dcx="reactions-panel"][data-comment="${e}"]`,i=document.querySelector(s),a=i.getBoundingClientRect(),c=i.parentNode.parentNode.getBoundingClientRect();t.style.bottom=`${n}px`,t.style.left=a.x-c.x-r+"px"}}function on_mouseover_reaction_btn(e){return t=>{e.textContent=t.target.getAttribute("data-title")}}function on_mouseout_reaction_btn(e,t){return o=>e.textContent=t}function on_click_reaction_btn(e,t){return o=>{o.preventDefault(),async function post_reaction(e){return(await fetch(window.dcx.react_url,{method:"POST",cache:"no-cache",credentials:"same-origin",headers:{"X-CSRFToken":get_cookie("csrftoken"),"Content-Type":"application/json",Accept:"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)})).json()}({comment:t,reaction:e}).then((e=>{!function handle_reaction_response(e,t){const o=document.getElementById(`cm-footer-${e}`),n=document.getElementById(`cm-reactions-${e}`);if(t.counter>0){const r=function create_reactions_list(e){const t=document.querySelector("[data-dcx=config]"),o=document.createElement("div");o.className="active-reactions",o.setAttribute("data-tooltip-pos-bottom",t.getAttribute("data-tooltip-pos-bottom")),o.setAttribute("data-tooltip-pos-left",t.getAttribute("data-tooltip-pos-left"));for(const n of e.list){const e=document.createElement("span");e.className="reaction",e.dataset.reaction=n.value,e.appendChild(create_tooltip(n));const t=document.createElement("a");t.className="small text-primary",t.setAttribute("data-toggle","reactions-tooltip"),t.addEventListener("mouseover",on_mouseover_tooltip),t.addEventListener("mouseout",on_mouseout_tooltip),t.appendChild(document.createTextNode(`${n.counter}`));const r=document.createElement("span");r.className="emoji",r.innerHTML=`&${n.icon};`,t.appendChild(r),e.appendChild(t),o.appendChild(e)}return o}(t);if(null===n){const t=document.createElement("div");t.id=`cm-reactions-${e}`,t.className="reactions",t.appendChild(r),t.insertAdjacentHTML("beforeend","&nbsp;"),o.insertBefore(t,o.children[0]),t.insertAdjacentHTML("afterend","&nbsp;")}else{const e=n.querySelector(".active-reactions");n.replaceChild(r,e)}}else if(n){n.remove();for(const e of o.childNodes)e.nodeType===Node.TEXT_NODE&&(e.textContent="")}calc_buttons_panel_position(e)}(t,e)}))}}function on_mouseover_tooltip(e){const t=e.target.parentNode.parentNode,o=parseInt(t.getAttribute("data-tooltip-pos-bottom"))||0,n=parseInt(t.getAttribute("data-tooltip-pos-left"))||0,r=e.target.parentNode.children[0],s=e.target.getBoundingClientRect(),i=t.getBoundingClientRect();"reactions-tooltip"===r.className&&(r.style.display="block",r.style.bottom=`${o}px`,r.style.left=s.x-i.x-n+"px")}function on_mouseout_tooltip(e){const t=e.target.parentNode.children[0];"reactions-tooltip"===t.className&&(t.style.display="")}function get_cookie(e){let t=null;if(document.cookie&&""!==document.cookie){const o=document.cookie.split(";");for(let n=0;n<o.length;n++){const r=o[n].trim();if(r.substring(0,e.length+1)===e+"="){t=decodeURIComponent(r.substring(e.length+1));break}}}return t}function create_tooltip(e){const t=document.createElement("div");t.className="reactions-tooltip";const o=document.createElement("div");o.className="arrow",t.appendChild(o);const n=document.createElement("p");return n.textContent=`${e.authors.join(", ")} reacted with ${e.label}`,t.appendChild(n),t}window.addEventListener("mouseup",(e=>{"reactions-panel"!==e.target.getAttribute("data-dcx")&&document.querySelectorAll(".reactions-panel").forEach((e=>{e.style.display="none"}))})),window.addEventListener("keyup",(e=>{"Escape"===e.key&&document.querySelectorAll(".reactions-panel").forEach((e=>{e.style.display="none"}))})),window.dcx.init_comments=init_comments,window.dcx.init_reactions=init_reactions,window.addEventListener("DOMContentLoaded",(e=>{null!==window.dcx&&(init_comments(),init_reactions())}))})();
//# sourceMappingURL=dcx-3.0.0.min.js.map